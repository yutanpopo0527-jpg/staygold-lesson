<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>レッスンスケジュール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        amber: {
                            50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d',
                            400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309',
                            800: '#92400e', 900: '#78350f',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #fffbeb;
            background-image: url("https://www.transparenttextures.com/patterns/wood-pattern.png");
            overflow-x: hidden;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            width: 100%;
        }
        #calendar-container {
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        #calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .day-cell {
            height: 120px;
            border-right: 1px solid #fef3c7;
            border-bottom: 1px solid #fef3c7;
            padding: 4px;
            display: flex;
            flex-direction: column;
            background-color: white;
            overflow: hidden;
        }
        .day-cell:nth-child(7n) { border-right: none; }
        .event-card {
            font-size: 0.75rem;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 4px;
            cursor: pointer;
            word-break: break-all;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            display: block;
        }
        @media (max-width: 640px) {
            .day-cell { height: 100px; padding: 1px; }
            .event-card {
                font-size: 10px !important;
                transform: scale(0.85);
                transform-origin: left top;
                width: 117%;
                margin-bottom: -1px;
                padding: 1px 2px !important;
                letter-spacing: -0.05em;
            }
        }
        .event-acoustic { background-color: #fef3c7; border-left: 3px solid #d97706; color: #92400e; }
        .event-electric { background-color: #e0f2fe; border-left: 3px solid #0284c7; color: #075985; }
        .event-shared { background-color: #f0fdf4; border-left: 3px solid #16a34a; color: #166534; font-weight: bold; }
        .event-container::-webkit-scrollbar { width: 3px; }
        .event-container::-webkit-scrollbar-thumb { background: #d97706; border-radius: 10px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="min-h-screen pb-10">

<div id="app" class="max-w-6xl mx-auto px-2 sm:px-4 pt-4">
    <header class="flex flex-col md:flex-row justify-between items-center mb-4 bg-amber-800 p-3 sm:p-4 rounded-xl shadow-lg text-white border-b-4 border-amber-900">
        <h1 class="text-xl sm:text-2xl font-bold flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
            レッスンスケジュール
        </h1>
        <div class="flex items-center gap-2 sm:gap-4 mt-3 md:mt-0">
            <div id="search-container" class="relative text-gray-800">
                <input type="text" id="student-search" placeholder="お名前を検索..." class="pl-8 pr-4 py-1.5 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 w-40 sm:w-64">
                <svg class="absolute left-2.5 top-2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </div>
            <button id="admin-toggle-btn" class="bg-amber-600 hover:bg-amber-700 px-3 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-colors shadow-inner border border-amber-500">
                先生ログイン
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <div id="calendar-container" class="lg:col-span-4 bg-white rounded-xl shadow-xl overflow-hidden border border-amber-200">
            <div class="grid grid-cols-3 items-center p-2 sm:p-4 bg-amber-50 border-b border-amber-100">
                <div class="flex justify-start"></div>
                <div class="flex items-center justify-center gap-2 sm:gap-6">
                    <button id="prev-month" class="p-2 hover:bg-amber-200 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <h2 id="current-month-display" class="text-base sm:text-xl font-bold text-amber-900 text-center whitespace-nowrap min-w-[120px] sm:min-w-[150px]">読み込み中...</h2>
                    <button id="next-month" class="p-2 hover:bg-amber-200 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                    </button>
                </div>
                <div class="flex justify-end items-center gap-2">
                    <div id="admin-actions" class="hidden flex">
                        <button id="export-btn" title="Googleカレンダー用にCSV出力" class="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="calendar-grid bg-amber-100 text-amber-800 text-[10px] sm:text-sm font-bold border-b border-amber-200 text-center">
                <div class="py-2 text-red-600">日</div>
                <div class="py-2">月</div>
                <div class="py-2">火</div>
                <div class="py-2">水</div>
                <div class="py-2">木</div>
                <div class="py-2">金</div>
                <div class="py-2 text-blue-600">土</div>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
        </div>

        <div id="sidebar" class="hidden lg:col-span-1 space-y-4">
            <div id="admin-student-list" class="bg-white rounded-xl shadow-xl p-4 border border-amber-200">
                <h3 class="text-lg font-bold text-amber-900 mb-4 border-b-2 border-amber-100 pb-2">生徒名簿</h3>
                <div class="space-y-3">
                    <div class="flex flex-col gap-2 p-2 bg-amber-50 rounded-lg border border-amber-100 mb-4">
                        <input type="text" id="new-student-name" placeholder="生徒名" class="w-full border border-amber-200 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-amber-500">
                        <div class="flex gap-2">
                            <select id="new-student-time" class="flex-1 border border-amber-200 rounded px-1 py-1 text-xs focus:outline-none"></select>
                            <select id="new-student-guitar" class="flex-1 border border-amber-200 rounded px-1 py-1 text-xs focus:outline-none">
                                <option value="acoustic">アコギ</option>
                                <option value="electric">エレキ</option>
                            </select>
                        </div>
                        <button id="add-student-btn" class="w-full bg-amber-500 text-white py-1.5 rounded text-xs font-bold hover:bg-amber-600">追加</button>
                    </div>
                    <p class="text-[10px] text-gray-500">※ドラッグして予約を作成</p>
                    <div id="students-container" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="password-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm border-4 border-amber-600">
            <h3 class="text-xl font-bold text-center text-amber-900 mb-4">パスワード入力</h3>
            <input type="password" id="admin-password" maxlength="4" placeholder="4桁の数字" class="w-full text-center text-2xl tracking-widest border-2 border-amber-200 rounded-lg p-2 mb-4 focus:outline-none focus:border-amber-500">
            <div class="flex gap-2">
                <button id="pw-cancel" class="flex-1 py-2 bg-gray-200 rounded-lg font-bold hover:bg-gray-300">キャンセル</button>
                <button id="pw-submit" class="flex-1 py-2 bg-amber-600 text-white rounded-lg font-bold hover:bg-amber-700 transition-shadow">ログイン</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md border border-amber-200">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-amber-900">レッスンの登録</h3>
                <button id="event-close" class="text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            </div>
            <form id="event-form" class="space-y-4">
                <input type="hidden" id="event-id"><input type="hidden" id="event-date">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">イベント種別</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-sm"><input type="radio" name="event-type" value="individual" checked> 個人レッスン</label>
                        <label class="flex items-center gap-2 text-sm"><input type="radio" name="event-type" value="shared"> 全員共有</label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">レッスン生名 / イベント名</label>
                    <input type="text" id="event-student" required class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-1 focus:ring-amber-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">開始時間</label>
                        <select id="event-start" class="w-full border border-gray-300 rounded px-3 py-2"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">終了時間</label>
                        <select id="event-end" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-1 focus:ring-amber-500 outline-none"></select>
                    </div>
                </div>
                <div id="guitar-type-section">
                    <label class="block text-sm font-bold text-gray-700 mb-1">ギターの種類</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 text-sm"><input type="radio" name="guitar-type" value="acoustic" checked> アコギ</label>
                        <label class="flex items-center gap-2 text-sm"><input type="radio" name="guitar-type" value="electric"> エレキ</label>
                    </div>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="button" id="event-delete" class="hidden bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200">削除</button>
                    <div class="flex-1"></div>
                    <button type="submit" id="event-save" class="bg-amber-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-amber-700 shadow-lg">保存する</button>
                </div>
            </form>
        </div>
    </div>

    <div id="drag-choice-modal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-xs border border-amber-200 text-center">
            <h3 class="text-lg font-bold text-amber-900 mb-4">予定の操作を選択</h3>
            <div class="grid grid-cols-1 gap-3">
                <button id="drag-move" class="py-3 bg-amber-600 text-white rounded-xl font-bold hover:bg-amber-700">移動する</button>
                <button id="drag-copy" class="py-3 bg-amber-100 text-amber-700 rounded-xl font-bold hover:bg-amber-200">コピー(複製)する</button>
                <button id="drag-cancel" class="py-2 text-gray-500 text-sm">キャンセル</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Firebase初期設定
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'lesson-calendar-app';

    // Firestoreのパス設定 (Rule 1準拠)
    const EVENTS_PATH = ['artifacts', appId, 'public', 'data', 'events'];
    const STUDENTS_PATH = ['artifacts', appId, 'public', 'data', 'students'];

    // 状態管理
    let isAdmin = false;
    let currentDate = new Date();
    let events = [];
    let students = [];
    let user = null;

    // 定数
    const HOLIDAYS = {
        '2025-01-01': '元日', '2025-01-13': '成人の日', '2025-02-11': '建国記念の日', '2025-02-23': '天皇誕生日',
        '2025-02-24': '振替休日', '2025-03-20': '春分の日', '2025-04-29': '昭和の日', '2025-05-03': '憲法記念日',
        '2025-05-04': 'みどりの日', '2025-05-05': 'こどもの日', '2025-05-06': '振替休日', '2025-07-21': '海の日', '2025-08-11': '山の日',
        '2025-09-15': '敬老の日', '2025-09-22': '国民の休日', '2025-09-23': '秋分の日', '2025-10-13': 'スポーツの日', '2025-11-03': '文化の日',
        '2025-11-23': '勤労感謝の日', '2025-11-24': '振替休日'
    };

    // DOM要素
    const calendarDays = document.getElementById('calendar-days');
    const calendarContainer = document.getElementById('calendar-container');
    const sidebar = document.getElementById('sidebar');
    const currentMonthDisplay = document.getElementById('current-month-display');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const adminToggleBtn = document.getElementById('admin-toggle-btn');
    const studentsContainer = document.getElementById('students-container');
    const studentSearch = document.getElementById('student-search');
    const passwordModal = document.getElementById('password-modal');
    const adminPasswordInput = document.getElementById('admin-password');
    const pwSubmitBtn = document.getElementById('pw-submit');
    const pwCancelBtn = document.getElementById('pw-cancel');
    const eventModal = document.getElementById('event-modal');
    const eventForm = document.getElementById('event-form');
    const dragChoiceModal = document.getElementById('drag-choice-modal');

    let draggedEventId = null;
    let draggedStudentObj = null;
    let dropTargetDate = null;

    // 共通関数
    const formatYMD = (date) => {
        const d = new Date(date);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    };

    // Firestore書き込み関数
    const dbSaveEvent = async (eventData) => {
        if (!user) return;
        await setDoc(doc(db, ...EVENTS_PATH, eventData.id), eventData);
    };

    const dbDeleteEvent = async (id) => {
        if (!user) return;
        await deleteDoc(doc(db, ...EVENTS_PATH, id));
    };

    const dbSaveStudent = async (studentData) => {
        if (!user) return;
        await setDoc(doc(db, ...STUDENTS_PATH, studentData.id), studentData);
    };

    const dbDeleteStudent = async (id) => {
        if (!user) return;
        await deleteDoc(doc(db, ...STUDENTS_PATH, id));
    };

    // UI描画
    const renderCalendar = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        currentMonthDisplay.textContent = `${year}年 ${month + 1}月`;
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        calendarDays.innerHTML = '';
        const searchTerm = studentSearch.value.trim().toLowerCase();

        if (isAdmin) {
            calendarContainer.classList.replace('lg:col-span-4', 'lg:col-span-3');
            sidebar.classList.remove('hidden');
        } else {
            calendarContainer.classList.replace('lg:col-span-3', 'lg:col-span-4');
            sidebar.classList.add('hidden');
        }

        const totalCells = Math.ceil((firstDay + lastDate) / 7) * 7;
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = `day-cell`;
            const dateObj = new Date(year, month, i - firstDay + 1);
            const isCurrentMonth = dateObj.getMonth() === month;
            if (!isCurrentMonth) cell.classList.add('bg-gray-50', 'text-gray-400');
            const ymd = formatYMD(dateObj);
            const holiday = HOLIDAYS[ymd];

            const header = document.createElement('div');
            header.className = 'flex items-baseline gap-1 px-1 mb-1';
            const dayNum = document.createElement('span');
            dayNum.className = `text-[10px] sm:text-xs font-bold ${isCurrentMonth ? '' : 'opacity-40'}`;
            if (dateObj.getDay() === 0 || holiday) dayNum.classList.add('text-red-500');
            else if (dateObj.getDay() === 6) dayNum.classList.add('text-blue-500');
            dayNum.textContent = dateObj.getDate();
            header.appendChild(dayNum);
            if (holiday) {
                const hLabel = document.createElement('span');
                hLabel.className = 'text-[8px] sm:text-[10px] text-red-500/80 truncate font-medium';
                hLabel.textContent = holiday;
                header.appendChild(hLabel);
            }
            cell.appendChild(header);

            if (isAdmin) {
                cell.ondragover = (e) => e.preventDefault();
                cell.ondrop = () => handleCellDrop(ymd);
                cell.onclick = () => openEventModal(ymd);
                cell.classList.add('cursor-pointer', 'hover:bg-amber-50');
            }

            const eventContainer = document.createElement('div');
            eventContainer.className = 'event-container flex-1 overflow-y-auto px-0.5 space-y-0.5';
            const cellEvents = events.filter(ev => ev.date === ymd).sort((a, b) => a.start.localeCompare(b.start));
            cellEvents.forEach(ev => {
                const isShared = ev.type === 'shared';
                let shouldShow = isAdmin ? (!searchTerm || ev.student.toLowerCase().includes(searchTerm) || isShared) : (isShared || (searchTerm && ev.student.toLowerCase().includes(searchTerm)));
                if (shouldShow) {
                    const evEl = document.createElement('div');
                    evEl.className = `event-card ${isShared ? 'event-shared' : (ev.guitar === 'electric' ? 'event-electric' : 'event-acoustic')}`;
                    evEl.innerHTML = `${isShared ? '☆' : ev.start + ' '}${ev.student}`;
                    if (isAdmin) {
                        evEl.draggable = true;
                        evEl.ondragstart = (e) => { e.stopPropagation(); draggedEventId = ev.id; };
                        evEl.onclick = (e) => { e.stopPropagation(); openEventModal(ev.date, ev); };
                    }
                    eventContainer.appendChild(evEl);
                }
            });
            cell.appendChild(eventContainer);
            calendarDays.appendChild(cell);
        }
    };

    const renderStudents = () => {
        studentsContainer.innerHTML = '';
        students.forEach((s) => {
            const div = document.createElement('div');
            div.className = 'flex flex-col bg-white p-2 rounded border border-amber-200 shadow-sm cursor-move group hover:border-amber-400';
            div.draggable = true;
            div.ondragstart = () => { draggedStudentObj = s; draggedEventId = null; };
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-xs font-bold text-amber-900';
            nameSpan.textContent = s.name;
            header.appendChild(nameSpan);
            const delBtn = document.createElement('button');
            delBtn.className = 'text-red-300 hover:text-red-500';
            delBtn.innerHTML = '×';
            delBtn.onclick = (e) => { e.stopPropagation(); dbDeleteStudent(s.id); };
            header.appendChild(delBtn);
            div.appendChild(header);
            studentsContainer.appendChild(div);
        });
    };

    // 時間設定
    const generateTimeOptions = () => {
        const startSelect = document.getElementById('event-start');
        const endSelect = document.getElementById('event-end');
        const regTimeSelect = document.getElementById('new-student-time');
        for(let h=8; h<=23; h++) {
            for(let m of ['00', '30']) {
                const time = `${String(h).padStart(2, '0')}:${m}`;
                const opt = document.createElement('option');
                opt.value = time;
                opt.textContent = time;
                startSelect.appendChild(opt);
                endSelect.appendChild(opt.cloneNode(true));
                regTimeSelect.appendChild(opt.cloneNode(true));
            }
        }
    };

    const updateEndTime = () => {
        const eventType = document.querySelector('input[name="event-type"]:checked').value;
        const start = document.getElementById('event-start').value;
        const endSelect = document.getElementById('event-end');
        if (eventType === 'individual') {
            const [h, m] = start.split(':').map(Number);
            const calculatedEnd = `${String(h + 1).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            endSelect.value = calculatedEnd;
            endSelect.disabled = true;
            endSelect.classList.add('bg-gray-50', 'text-gray-500');
        } else {
            endSelect.disabled = false;
            endSelect.classList.remove('bg-gray-50', 'text-gray-500');
        }
    };

    const toggleGuitarTypeVisibility = () => {
        const type = document.querySelector('input[name="event-type"]:checked').value;
        document.getElementById('guitar-type-section').style.display = (type === 'individual') ? 'block' : 'none';
        updateEndTime();
    };

    // モーダル操作
    const openEventModal = (date, event = null) => {
        if (!isAdmin) return;
        document.getElementById('event-id').value = event ? event.id : '';
        document.getElementById('event-date').value = date;
        document.getElementById('event-student').value = event ? event.student : '';
        document.getElementById('event-start').value = event ? event.start : '10:00';
        
        if (event) {
            document.querySelector(`input[name="event-type"][value="${event.type}"]`).checked = true;
            document.querySelector(`input[name="guitar-type"][value="${event.guitar}"]`).checked = true;
            document.getElementById('event-end').value = event.end;
            document.getElementById('event-delete').classList.remove('hidden');
        } else {
            document.querySelector('input[name="event-type"][value="individual"]').checked = true;
            document.querySelector('input[name="guitar-type"][value="acoustic"]').checked = true;
            document.getElementById('event-delete').classList.add('hidden');
        }
        updateEndTime();
        toggleGuitarTypeVisibility();
        eventModal.classList.remove('hidden');
    };

    const handleCellDrop = (date) => {
        if (draggedStudentObj) {
            const [h, m] = draggedStudentObj.time.split(':').map(Number);
            dbSaveEvent({ 
                id: Date.now().toString(), 
                date, 
                student: draggedStudentObj.name, 
                start: draggedStudentObj.time, 
                end: `${String(h + 1).padStart(2, '0')}:${String(m).padStart(2, '0')}`, 
                type: 'individual', 
                guitar: draggedStudentObj.guitar 
            });
            draggedStudentObj = null;
        } else if (draggedEventId) {
            dropTargetDate = date; 
            dragChoiceModal.classList.remove('hidden');
        }
    };

    const handleDragAction = async (action) => {
        const event = events.find(e => e.id === draggedEventId);
        if (!event) return;
        if (action === 'move') {
            await dbSaveEvent({ ...event, date: dropTargetDate });
        } else if (action === 'copy') {
            await dbSaveEvent({ ...event, id: Date.now().toString(), date: dropTargetDate });
        }
        draggedEventId = null; 
        dragChoiceModal.classList.add('hidden');
    };

    // イベントリスナー
    prevMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
    nextMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };
    adminToggleBtn.onclick = () => {
        if (isAdmin) { isAdmin = false; adminToggleBtn.textContent = '先生ログイン'; document.getElementById('admin-actions').classList.add('hidden'); renderCalendar(); }
        else { passwordModal.classList.remove('hidden'); adminPasswordInput.focus(); }
    };
    pwCancelBtn.onclick = () => { passwordModal.classList.add('hidden'); adminPasswordInput.value = ''; };
    pwSubmitBtn.onclick = () => {
        if (adminPasswordInput.value === '0927') { isAdmin = true; adminToggleBtn.textContent = 'ログアウト'; document.getElementById('admin-actions').classList.remove('hidden'); passwordModal.classList.add('hidden'); adminPasswordInput.value = ''; renderCalendar(); renderStudents(); }
        else alert('パスワードが違います');
    };
    studentSearch.oninput = () => renderCalendar();
    document.getElementById('add-student-btn').onclick = () => {
        const name = document.getElementById('new-student-name').value;
        if (name.trim()) {
            dbSaveStudent({ 
                id: Date.now().toString(), 
                name: name.trim(), 
                time: document.getElementById('new-student-time').value, 
                guitar: document.getElementById('new-student-guitar').value 
            });
            document.getElementById('new-student-name').value = '';
        }
    };
    document.getElementById('event-close').onclick = () => eventModal.classList.add('hidden');
    document.getElementById('event-start').onchange = updateEndTime;
    document.querySelectorAll('input[name="event-type"]').forEach(r => r.onchange = toggleGuitarTypeVisibility);
    
    eventForm.onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('event-id').value || Date.now().toString();
        const data = { 
            id, 
            date: document.getElementById('event-date').value, 
            student: document.getElementById('event-student').value, 
            start: document.getElementById('event-start').value, 
            end: document.getElementById('event-end').value, 
            type: document.querySelector('input[name="event-type"]:checked').value, 
            guitar: document.querySelector('input[name="guitar-type"]:checked').value 
        };
        await dbSaveEvent(data);
        eventModal.classList.add('hidden');
    };
    document.getElementById('event-delete').onclick = () => { dbDeleteEvent(document.getElementById('event-id').value); eventModal.classList.add('hidden'); };
    document.getElementById('drag-move').onclick = () => handleDragAction('move');
    document.getElementById('drag-copy').onclick = () => handleDragAction('copy');
    document.getElementById('drag-cancel').onclick = () => { dragChoiceModal.classList.add('hidden'); draggedEventId = null; };
    document.getElementById('export-btn').onclick = () => {
        let csv = "Subject,Start Date,Start Time,End Date,End Time,Description\n";
        events.filter(e => new Date(e.date).getMonth() === currentDate.getMonth()).forEach(e => csv += `"${e.student}","${e.date.replace(/-/g, '/')}","${e.start}","${e.date.replace(/-/g, '/')}","${e.end}",""\n`);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `lessons_${currentDate.getFullYear()}_${currentDate.getMonth()+1}.csv`;
        link.click();
    };

    // Firebase同期処理
    const initApp = async () => {
        generateTimeOptions();
        
        // 認証
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (!user) return;

            // イベント同期
            onSnapshot(collection(db, ...EVENTS_PATH), (snapshot) => {
                events = snapshot.docs.map(d => d.data());
                renderCalendar();
            }, (err) => console.error("Event Sync Error", err));

            // 生徒名簿同期
            onSnapshot(collection(db, ...STUDENTS_PATH), (snapshot) => {
                students = snapshot.docs.map(d => d.data());
                if (isAdmin) renderStudents();
            }, (err) => console.error("Student Sync Error", err));
        });
    };

    window.onload = initApp;
</script>
</body>
</html>
